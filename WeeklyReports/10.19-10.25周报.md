```
本周学习mmdetection的代码并跑起来，主要对Faster R-CNN和Mask R-CNN进行实验，展示了可视化和量化结果。
```



# 量化评估指标

- precision 精确率
  $$
  precision = \frac{TP}{TP+FP}
  $$

  - 表示预测为正类的样本中，有多少是真正的**正样本**

- average precision（AP）：每个类别的precision平均值

- mean average precision（mAP）：对所有类别的AP求均值

- recall 召回率
  $$
  recall = \frac{TP}{TP+FN}
  $$

  - 表示在**正样本**中，有多少被召回为正类

- average recall（AR）：每个类别的recall平均值

- mean average recall（mAR）：对所有类别的AR求均值

- TP/FP的计算：AP主要使用IoU来评估，也有通过不同尺寸物体（small/medium/large）来评估

  ![](..\Figures\RCNNExps\mAP.png)

  - IoU：预测结果与**ground truth**（GT）的交并比
    $$
    IoU=\frac{ground\ truth \cap prediction}{ground\ truth \cup prediction}
    $$
    

  - TP（True Positive）：当IoU>=某个阈值（0.5/0.75/0.95）

  - FP（False Positive）：当IoU<某个阈值（0.5/0.75/0.95）



# Faster R-CNN

from github:[mmdetection](https://github.com/open-mmlab/mmdetection)

## 1 训练

- loss函数（详见Faster R-CNN.md）
  $$
  L(\{p_i\},\{t_i\})=\frac{1}{N_{cls}}\sum_iL_{cls}(p_i,p_i^*)+\lambda\frac{1}{N_{reg}}\sum_ip_i^*L_{reg}(t_i,t_i^*)\\
  其中，i：即批次中的第i个anchor，p_i：即第i个anchor是一个目标的概率，\\
  p_i^*：即真值标签，若anchor为是正的，则为1，是负的，则为0，\\
  t_i：是一个向量，用来表示预测的包围盒的四个参数化的坐标，\\
  t_i^*：表示和正的anchor相关的真值框。\\
  L_{cls}：表示分类的损失，L_{reg}：表示回归的损失
  $$

### (1) 使用coco数据集

- 主干网络backbone：ResNET101-FPN

- loss曲线

  1. 分类loss
  2. 包围盒回归loss
  3. loss

  ![](..\Figures\RCNNExps\faster_rcnn_coco_loss.JPG)

### (2) 使用PASCAL VOC数据集

- 主干网络backbone：ResNET50

- loss曲线
  
  1. 分类loss
  2. 包围盒回归loss
  3. loss
  
  ![](..\Figures\RCNNExps\faster_rcnn_voc_loss.JPG)

## 2 测试

### (1) 使用coco数据集val2017

#### ① 量化评估

- 包围盒的 mAP 和 mAR)
  - 当IoU的阈值取0.5时，mAP较高，过0.6

```python
Average Precision  (mAP) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.394
Average Precision  (mAP) @[ IoU=0.50      | area=   all | maxDets=1000 ] = 0.601
Average Precision  (mAP) @[ IoU=0.75      | area=   all | maxDets=1000 ] = 0.431
Average Precision  (mAP) @[ IoU=0.50:0.95 | area= small | maxDets=1000 ] = 0.224
Average Precision  (mAP) @[ IoU=0.50:0.95 | area=medium | maxDets=1000 ] = 0.437
Average Precision  (mAP) @[ IoU=0.50:0.95 | area= large | maxDets=1000 ] = 0.511
Average Recall     (mAR) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.533
Average Recall     (mAR) @[ IoU=0.50:0.95 | area=   all | maxDets=300 ] = 0.533
Average Recall     (mAR) @[ IoU=0.50:0.95 | area=   all | maxDets=1000 ] = 0.533
Average Recall     (mAR) @[ IoU=0.50:0.95 | area= small | maxDets=1000 ] = 0.334
Average Recall     (mAR) @[ IoU=0.50:0.95 | area=medium | maxDets=1000 ] = 0.580
Average Recall     (mAR) @[ IoU=0.50:0.95 | area= large | maxDets=1000 ] = 0.676
```

#### ② 部分测试效果图如下

![](..\Figures\RCNNExps\coco_faster.JPG)

### (2) 使用PASCAL VOC2012数据集val

#### ① 量化评估

- 包围盒的mAP
  - 绝大部分类别的AP过0.9，mAP达0.922，效果不错

```python
+-------------+------+-------+--------+-------+
| class       | gts  | dets  | recall | ap    |
+-------------+------+-------+--------+-------+
| aeroplane   | 433  | 1246  | 0.972  | 0.953 |
| bicycle     | 358  | 1147  | 0.953  | 0.924 |
| bird        | 559  | 1177  | 0.980  | 0.967 |
| boat        | 424  | 1765  | 0.960  | 0.904 |
| bottle      | 630  | 1917  | 0.962  | 0.918 |
| bus         | 301  | 900   | 0.983  | 0.961 |
| car         | 1004 | 2736  | 0.970  | 0.945 |
| cat         | 612  | 1369  | 0.990  | 0.981 |
| chair       | 1176 | 5511  | 0.957  | 0.865 |
| cow         | 298  | 1114  | 0.987  | 0.946 |
| diningtable | 305  | 1930  | 0.859  | 0.722 |
| dog         | 759  | 1947  | 0.995  | 0.984 |
| horse       | 360  | 964   | 0.983  | 0.963 |
| motorbike   | 356  | 1131  | 0.980  | 0.952 |
| person      | 4372 | 11337 | 0.979  | 0.954 |
| pottedplant | 489  | 2546  | 0.963  | 0.871 |
| sheep       | 413  | 996   | 0.971  | 0.952 |
| sofa        | 285  | 1330  | 0.947  | 0.792 |
| train       | 315  | 935   | 0.971  | 0.951 |
| tvmonitor   | 392  | 1353  | 0.957  | 0.925 |
+-------------+------+-------+--------+-------+
| mAP         |      |       |        | 0.922 |
+-------------+------+-------+--------+-------+
```

#### ② 部分测试效果图

![](..\Figures\RCNNExps\voc.JPG)



# Mask R-CNN

from github:[mmdetection](https://github.com/open-mmlab/mmdetection)

## 1 训练

- loss函数（详见Mask R-CNN.md）：在原损失函数基础上增加mask损失
  $$
  L=L_{cls}+L_{box}+L_{mask}
  $$

  - mask分支中对每个RoI有K（类别数）\*m（长）\*m（宽）个二元mask的输出
  - 应用了per-pixel sigmoid，将mask损失函数定义为**平均二元交叉熵**损失

### (1) 使用coco数据集

- 主干网络backbone：ResNET101-FPN

  - Mask R-CNN论文中提出使用**ResNet-FPN**（Feature Pyramid Network）对特征提取有很大提高

  <img src="..\Figures\Mask R-CNN\ResNet-FPN.JPG" style="zoom:67%;" />

- loss曲线
  
  1. 分类loss
  2. 包围盒loss
  3. mask loss
  4. loss
  
  ![](..\Figures\RCNNExps\mask_rcnn_coco_loss.JPG)

## 2 测试

### (1) 使用coco数据集val2017

#### ① 量化评估

- 包围盒的mAP和 mAR 
  - 同上面Faster R-CNN，当IoU阈值取0.5时，mAP较高，过0.6

```python
Average Precision  (mAP) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.400
Average Precision  (mAP) @[ IoU=0.50      | area=   all | maxDets=1000 ] = 0.605
Average Precision  (mAP) @[ IoU=0.75      | area=   all | maxDets=1000 ] = 0.440
Average Precision  (mAP) @[ IoU=0.50:0.95 | area= small | maxDets=1000 ] = 0.226
Average Precision  (mAP) @[ IoU=0.50:0.95 | area=medium | maxDets=1000 ] = 0.440
Average Precision  (mAP) @[ IoU=0.50:0.95 | area= large | maxDets=1000 ] = 0.526
Average Recall     (mAR) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.538
Average Recall     (mAR) @[ IoU=0.50:0.95 | area=   all | maxDets=300 ] = 0.538
Average Recall     (mAR) @[ IoU=0.50:0.95 | area=   all | maxDets=1000 ] = 0.538
Average Recall     (mAR) @[ IoU=0.50:0.95 | area= small | maxDets=1000 ] = 0.335
Average Recall     (mAR) @[ IoU=0.50:0.95 | area=medium | maxDets=1000 ] = 0.583
Average Recall     (mAR) @[ IoU=0.50:0.95 | area= large | maxDets=1000 ] = 0.683
```

- mask的mAP和 mAR
  - 同包围盒，当IoU的阈值取0.5时，mAP较高，但不到0.6，略低

```python
Average Precision  (mAP) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.361
Average Precision  (mAP) @[ IoU=0.50      | area=   all | maxDets=1000 ] = 0.575
Average Precision  (mAP) @[ IoU=0.75      | area=   all | maxDets=1000 ] = 0.386
Average Precision  (mAP) @[ IoU=0.50:0.95 | area= small | maxDets=1000 ] = 0.188
Average Precision  (mAP) @[ IoU=0.50:0.95 | area=medium | maxDets=1000 ] = 0.397
Average Precision  (mAP) @[ IoU=0.50:0.95 | area= large | maxDets=1000 ] = 0.495
Average Recall     (mAR) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.487
Average Recall     (mAR) @[ IoU=0.50:0.95 | area=   all | maxDets=300 ] = 0.487
Average Recall     (mAR) @[ IoU=0.50:0.95 | area=   all | maxDets=1000 ] = 0.487
Average Recall     (mAR) @[ IoU=0.50:0.95 | area= small | maxDets=1000 ] = 0.286
Average Recall     (mAR) @[ IoU=0.50:0.95 | area=medium | maxDets=1000 ] = 0.529
Average Recall     (mAR) @[ IoU=0.50:0.95 | area= large | maxDets=1000 ] = 0.643
```

#### ② 部分测试效果图

![](..\Figures\RCNNExps\coco_mask.JPG)

### (2) 使用网络图片

- 对使用同一数据集（coco）训练以及采用统一backbone（ResNET101-FPN）的Faster R-CNN和Mask R-CNN进行测试，效果图如下

![](..\Figures\RCNNExps\volleyball.JPG)